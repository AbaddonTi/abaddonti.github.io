<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Фильтр данных по дате, команде и сотруднику</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/2.3.1/luxon.min.js"></script>
</head>
<body>
    <h1>Фильтр данных по дате, команде и сотруднику2</h1>
    <label for="start-date">Начальная дата и время (МСК):</label>
    <input type="datetime-local" id="start-date" onchange="filterData()">
    <br>
    <label for="end-date">Конечная дата и время (МСК):</label>
    <input type="datetime-local" id="end-date" onchange="filterData()">
    <br>
    <label for="team">Выбор команды:</label>
    <select id="team" onchange="updateEmployeeDropdown(); filterData();">
        <option value="Все">Все</option>
    </select>
    <br>
    <label for="employee">Выбор сотрудника:</label>
    <select id="employee" onchange="filterData()">
        <option value="Любой">Любой</option>
    </select>
    <br>
    <pre id="data-display">Ожидание данных...</pre>
    <div id="profit-display">Общий профит: </div>
    <div id="spread-display">Средний спред: </div>
    <div id="volume-display">Общий объем: </div>
    <div id="net-income-display">Чистая прибыль: </div>

    <script>
        let allRecords = [];
        let uniqueTeams = new Set();
        let uniqueEmployees = new Set();
        let teamEmployeeMap = {};

        // Уведомляем Grist о готовности виджета
        grist.ready({
            columns: ['Дата', 'Профит', 'Команда', 'Сотрудник', 'Спред', 'Объем', 'Операция', 'Сумма'],  // Запрашиваем колонки с датами, профитом, командой, сотрудником, спредом, объемом, операцией и суммой
            requiredAccess: 'read table'  // Устанавливаем уровень доступа для чтения данных таблицы
        });

        // Подписываемся на изменения данных в таблице
        grist.onRecords(function(records, mappings) {
            const mappedRecords = grist.mapColumnNames(records);
            if (mappedRecords) {
                allRecords = mappedRecords;  // Сохраняем все записи
                uniqueTeams = new Set(mappedRecords.map(record => record['Команда']));
                teamEmployeeMap = buildTeamEmployeeMap(mappedRecords);
                updateDropdown('team', uniqueTeams, 'Все');
                updateEmployeeDropdown();
                document.getElementById('data-display').innerHTML = 'Данные загружены. Используйте фильтры для фильтрации.';
            } else {
                console.error("Please map all columns correctly");
            }
        });

        function buildTeamEmployeeMap(records) {
            const map = {};
            records.forEach(record => {
                const team = record['Команда'];
                const employee = record['Сотрудник'];
                if (!map[team]) {
                    map[team] = new Set();
                }
                map[team].add(employee);
            });
            return map;
        }

        function updateDropdown(dropdownId, items, defaultOption) {
            const selectElement = document.getElementById(dropdownId);
            selectElement.innerHTML = `<option value="${defaultOption}">${defaultOption}</option>`;
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.text = item;
                selectElement.add(option);
            });
        }

        function updateEmployeeDropdown() {
            const selectedTeam = document.getElementById('team').value;
            let employees = new Set();
            if (selectedTeam === 'Все') {
                allRecords.forEach(record => employees.add(record['Сотрудник']));
            } else {
                employees = teamEmployeeMap[selectedTeam] || new Set();
            }
            updateDropdown('employee', employees, 'Любой');
        }

        function filterData() {
            const startDate = luxon.DateTime.fromISO(document.getElementById('start-date').value, { zone: 'Europe/Moscow' });
            const endDate = luxon.DateTime.fromISO(document.getElementById('end-date').value, { zone: 'Europe/Moscow' });
            const selectedTeam = document.getElementById('team').value;
            const selectedEmployee = document.getElementById('employee').value;

            if (!startDate.isValid || !endDate.isValid) {
                document.getElementById('data-display').innerHTML = 'Пожалуйста, введите корректные начальную и конечную даты.';
                return;
            }

            const filteredRecords = allRecords.filter(record => {
                const recordDate = luxon.DateTime.fromISO(record['Дата'], { zone: 'Europe/Moscow' });
                const isInDateRange = recordDate >= startDate && recordDate <= endDate;
                const isInTeam = selectedTeam === 'Все' || record['Команда'] === selectedTeam;
                const isInEmployee = selectedEmployee === 'Любой' || record['Сотрудник'] === selectedEmployee;
                return isInDateRange && isInTeam && isInEmployee;
            });

            if (filteredRecords.length > 0) {
                const profitSum = filteredRecords.reduce((sum, record) => sum + parseFloat(record['Профит'] || 0), 0).toFixed(2);
                const formattedProfitSum = formatCurrency(profitSum);

                const validSpreadRecords = filteredRecords.filter(record => record['Спред'] !== null);
                const spreadSum = validSpreadRecords.reduce((sum, record) => sum + parseFloat(record['Спред'] || 0), 0);
                const spreadAvg = (spreadSum / validSpreadRecords.length * 100).toFixed(2);

                const volumeSum = filteredRecords.reduce((sum, record) => sum + parseFloat(record['Объем'] || 0), 0).toFixed(2);
                const formattedVolumeSum = formatCurrency(volumeSum);

                let netIncome = 0;
                filteredRecords.forEach(record => {
                    console.log(`Операция: ${record['Операция']}, Сумма: ${record['Сумма']}`);
                    const operationText = record['Операция'];
                    if (recordHasColor(operationText, '#E1FEDE')) { // Зеленая ячейка
                        netIncome += parseFloat(record['Сумма'] || 0);
                    } else if (recordHasColor(operationText, '#FECBCC')) { // Красная ячейка
                        netIncome -= parseFloat(record['Сумма'] || 0);
                    }
                });
                const formattedNetIncome = formatCurrency(netIncome.toFixed(2));

                document.getElementById('data-display').innerHTML = filteredRecords.map(record => JSON.stringify(record)).join('\n');
                document.getElementById('profit-display').innerHTML = `Общий профит: ${formattedProfitSum} $`;
                document.getElementById('spread-display').innerHTML = `Средний спред: ${spreadAvg.replace('.', ',')} %`;
                document.getElementById('volume-display').innerHTML = `Общий объем: ${formattedVolumeSum} $`;
                document.getElementById('net-income-display').innerHTML = `Чистая прибыль: ${formattedNetIncome} $`;
            } else {
                document.getElementById('data-display').innerHTML = 'Записи не найдены в указанном диапазоне дат, команды и сотрудника.';
                document.getElementById('profit-display').innerHTML = 'Общий профит: 0.00 $';
                document.getElementById('spread-display').innerHTML = 'Средний спред: 0.00 %';
                document.getElementById('volume-display').innerHTML = 'Общий объем: 0.00 $';
                document.getElementById('net-income-display').innerHTML = 'Чистая прибыль: 0.00 $';
            }
        }

        function recordHasColor(operationText, color) {
            const dummyElement = document.createElement('div');
            dummyElement.style.backgroundColor = color;
            dummyElement.innerHTML = operationText;
            document.body.appendChild(dummyElement);
            const result = window.getComputedStyle(dummyElement).backgroundColor === color;
            document.body.removeChild(dummyElement);
            return result;
        }

        function formatCurrency(value) {
            return value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        }
    </script>
</body>
</html>
