<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Date Range Filter</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
</head>
<body>
    <h1>Filter Data by Date Range</h1>
    <label for="start-date">Start Date and Time:</label>
    <input type="datetime-local" id="start-date">
    <br>
    <label for="end-date">End Date and Time:</label>
    <input type="datetime-local" id="end-date">
    <br>
    <button onclick="filterData()">Filter Data</button>
    <pre id="data-display">Waiting for data...</pre>

    <script>
        let allRecords = [];

        // Уведомляем Grist о готовности виджета
        grist.ready({
            columns: ['Дата'],  // Запрашиваем колонку с датами
            requiredAccess: 'read table'  // Устанавливаем уровень доступа для чтения данных таблицы
        });

        // Подписываемся на изменения данных в таблице
        grist.onRecords(function(records, mappings) {
            const mappedRecords = grist.mapColumnNames(records);
            if (mappedRecords) {
                allRecords = mappedRecords;  // Сохраняем все записи
                document.getElementById('data-display').innerHTML = 'Data loaded. Use the date pickers to filter.';
            } else {
                console.error("Please map all columns correctly");
            }
        });

        function filterData() {
            const startDate = new Date(document.getElementById('start-date').value);
            const endDate = new Date(document.getElementById('end-date').value);

            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                document.getElementById('data-display').innerHTML = 'Please enter valid start and end dates.';
                return;
            }

            const filteredRecords = allRecords.filter(record => {
                const recordDate = new Date(record['Дата']);
                return recordDate >= startDate && recordDate <= endDate;
            });

            if (filteredRecords.length > 0) {
                document.getElementById('data-display').innerHTML = filteredRecords.map(record => JSON.stringify(record)).join('\n');
            } else {
                document.getElementById('data-display').innerHTML = 'No records found in the specified date range.';
            }
        }
    </script>
</body>
</html>
